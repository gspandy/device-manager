<!DOCTYPE html>
<html>
<head>
<title></title>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="../Css/zTreeStyle/zTreeStyle.css"> 
<link href="../../frame/css/bootstrap.min.css" rel="stylesheet" />
<link href="../../frame/css/bootstrap-responsive.min.css" rel="stylesheet" />
<link href="../../frame/css/font-awesome.css" rel="stylesheet" />
<link href="../../frame/css/style.css" rel="stylesheet" />
<link href="../../frame/css/style-responsive.css" rel="stylesheet" />
<link href="../../frame/css/style-default.css" rel="stylesheet" id="style_color" />
<script src="../../frame/js/jquery-1.8.3.min.js"></script>
<script src="../../frame/js/bootstrap.min.js"></script>
<script src="../Js/comm.js"></script>
<script src="../Js/plugin/jquery-validate/jquery.validate.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../Js/script/DeviceType_add.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="../Js/zTree/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../Js/zTree/jquery.ztree.core-3.5.min.js"></script>
<script type="text/javascript" src="../Js/script/Resource_add.js"></script>
<style type="text/css">
body{
	font-size: 12px;
	background-color: white;
}
#table_ {
	width: 850px;
}

#add_user {
	width: 800px;
	margin-left: 20px;
	margin-top: 10px;
}

#btn_div {
	text-align: center;
	margin-right: 10px;
}
#top_org {
 height: 18px;
 width: 100%;
 position: absolute;
 top: 5px;
 left: 0px;
}
#add_org {
 height: 500px;
 width: 500px;
 position: absolute;
 top: 50px;
 left: 320px;
 border:1px solid #CCCCCC;
}
#tree_div {
 height: 500px;
 width: 300px;
 position: absolute;
 left: 1%;
 top: 50px;
 border:1px solid #CCCCCC;
 overflow:-Scroll;
 overflow-x:hidden;
 overflow:-moz-scrollbars-vertical;
}
</style>

</head>
<body>
</br>
<div id="top_org">
&nbsp;&nbsp;&nbsp;&nbsp;资源名称：<input type="text" name="txtOrgname" id="txtResName" class="form-control" value="" style="height: 18px;margin-top: 10px">&nbsp;&nbsp;  
    <button type="submit" class="btn btn-primary" onClick="javascript:window.location.href='index2.html'">刷新</button>&nbsp;&nbsp;
     <button type="button" class="btn btn-success" id="addnew" onclick="clearText()">新增资源</button>
     <button type="button" class="btn btn-inverse" id="delete" onclick="deleteResource()" disabled="disabled">删除资源</button>
</div></br>
	<div class="panel panel-info" id="tree_div"> 
	    <ul id="tree" class="ztree"></ul>  
	</div> 
	<div class="panel panel-info" id="add_org">
		<div class="panel-body">
			<form class="form-horizontal" role="form" id="myform" style="margin-top: 20px">
				<div class="control-group">
					<label for="resourcecode" class="control-label">&nbsp;&nbsp;资源编号</label>
					<div class="controls controls-row">
						<input class="form-control" id="resourcecode" name="resourcecode"
							type="text" placeholder="请输入资源编号">
					</div>
				</div>
				<div class="control-group">
					<label for="resourcename" class="control-label">&nbsp;&nbsp;资源名称</label>
					<div class="controls controls-row">
						<input class="form-control" id="resourcename" name="resourcename"
							type="text" placeholder="请输入资源名称">
					</div>
				</div>
				<div class="control-group">
					<label for="resourcename" class="control-label">&nbsp;&nbsp;排序号</label>
					<div class="controls controls-row">
						<input class="form-control" id="sort" name="sort"
							type="text" placeholder="请输入排序号">
					</div>
				</div>
				<div class="control-group">
				<label for="resourcetype" class="control-label">&nbsp;&nbsp;资源类别
					</label>
					<div class="controls controls-row">
						<select name="resourcetype" id="resourcetype" class="form-control" >
							<option value="0">菜单</option>
							<!-- <option value="1">按钮</option> -->
						</select>
					</div>
				</div>
				<!-- <div class="control-group">
				<label for="menutype" class="control-label">菜单类别
					</label>
					<div class="controls controls-row">
						<select name="menutype" id="menutype" class="form-control" >
							<option value="9">系统管理</option>
							<option value="10">业务管理</option>
						</select>
					</div>
				</div> -->
				<div class="control-group">
					<label for="resourceurl" class="control-label">&nbsp;&nbsp;资源地址
					</label>
					<div class="controls controls-row">
						<input class="form-control" id="resourceurl" name="resourceurl"
							type="text" placeholder="请输入资源URL">
					</div>
				</div>
				
				<div class="control-group">
					<label for="resourceurl" class="control-label">&nbsp;&nbsp;资源图标
					</label>
					<div class="controls controls-row">
						<input class="form-control" id="i_con" name="i_con"
							type="text" placeholder="请输入资源图标">
					</div>
				</div>
				
				<div class="control-group">
					<label for="description" class="control-label">&nbsp;&nbsp;资源描述
					</label>
					<div class="controls controls-row">
						<textarea class="form-control" id="description" name="description"
							type="text" placeholder="请输入资源描述" rows="3" ></textarea>
					</div>
				</div>
				
				<div class="control-group">									
					<label for="description" class="control-label">&nbsp;&nbsp;是否启用
					</label>
					<div class="controls controls-row">
						<input type="radio" name="isenable" id="sex" value="1" checked="checked"> 启用
						<input type="radio" name="isenable" id="sex" value="2"> 不启用
					
					</div>
				</div>
				<input id="id" name="id" type="hidden">
				<input id="menutype" name="menutype" type="hidden" >
				<input id="stateflag" name="stateflag" type="hidden">
				<div id="btn_div">
					<button type="button" id="saveRes" class="btn btn-primary">保存</button>
					<button type="button" class="btn btn-success" onClick="javascript:window.location.href='../Resource/index.html';">返回列表</button>
				</div>
			</form>

		</div>
	</div>
</body>
</html>
<script language="JavaScript">  
    var setting = {  
   		view: {
   			  //dblClickExpand: false,
   			  expandSpeed: 10, //设置树展开的动画速度
   			  selectedMulti: false,
   			  fontCss: getFontCss
   		},
   		//获取json数据
        async : {  
            enable : true, 
            url : "../../ResourceAuthorityServlet?method=getAllResource" // Ajax 获取数据的 URL 地址  
            //autoParam : [ "id", "name" ] //ajax提交的时候，传的是id值
        },  
        data:{ // 必须使用data  
		 	key : {
        		name : "resourcename"
        	}, 
            simpleData : {  
                enable : true,  
                idKey : "id", // id编号命名   
                pIdKey : "menutype", // 父id编号命名    
                rootPId : 0
            }
        
        },
        edit : {
        	drag : {
        		autoExpandTrigger:true,
        		autoOpenTime:500
        	}
        },
        // 回调函数  
        callback : {  
            onClick : function(event, treeId, treeNode, clickFlag) {  //点击节点后绑定值到form
                if(true) {
                	$("#id").attr("value",treeNode.id);
                	$("#resourcecode").attr("value",treeNode.resourcecode);
                	$("#resourcename").attr("value",treeNode.resourcename);
                	$("#resourcetype").val(treeNode.resourcetype);
                	$("#menutype").val(treeNode.menutype);
                	$("#resourceurl").attr("value",treeNode.resourceurl);
                	$("#sort").attr("value",treeNode.sort);
                	$("#i_con").attr("value",treeNode.i_con);
                	document.getElementById("description").innerText=treeNode.description;
                	$("#stateflag").attr("value",treeNode.stateflag);
                	$("#delete").removeAttr("disabled");
                	if(treeNode.isenable=='1'){
                		$("input[name='isenable']").eq(0).attr("checked", "checked");
                		$("input[name='isenable']").eq(1).attr("checked", false);
                	}else{
                		$("input[name='isenable']").eq(0).attr("checked", false);
                		$("input[name='isenable']").eq(1).attr("checked", "checked");
                	}
                }  
            },  
            //捕获异步加载出现异常错误的事件回调函数 和 成功的回调函数  
            onAsyncSuccess : function(event, treeId, treeNode, msg){  
            	/* expAllNodes(); */
            	$.fn.zTree.getZTreeObj("tree").expandAll(true); 
            }  
        }  
    };  
  
    // 过滤函数  
    function filter(treeId, parentNode, childNodes) {  
        if (!childNodes)  
            return null;  
        for ( var i = 0, l = childNodes.length; i < l; i++) {  
           childNodes[i].name = childNodes[i].name.replace(/\.n/g, '.');  
        }  
        return childNodes;  
    }  
          
    function clearText(){
    	var zTree = $.fn.zTree.getZTreeObj("tree");
    	var nodes = zTree.getNodes();
    	var snodes = zTree.getSelectedNodes();
    	$("#id").attr("value","");
    	$("#resourcecode").attr("value","");
    	$("#resourcename").attr("value","");
    	$("#resourceurl").attr("value","");
    	$("#resourcetype").attr("value","0");
    	$("#stateflag").attr("value","");
    	$("#description").attr("value","");
    	if(snodes.length==0&&nodes.length>0){//存在节点，但没有选中节点
    		/* alert("请选择节点!");
    		return; */
    		$("#menutype").val(0);
    	}else if(snodes.length==0&&nodes.length==0){//没有任何节点也没有选中的节点
    		$("#menutype").val(0);
    	}else if(snodes.length>1){//选中了多个节点
    		alert("节点不允许多选!");
    		return;
    	}else{//选中了一个节点
    		var pid = snodes[0].id;
    		$("#menutype").val(pid); 
    	}
    	   	
    }
    
    function deleteResource(){
    	var msg = JSON.stringify($("#myform").serializeJson());
    	$.post("../../SysResourceServlet?method=deleteResourceById", {
			msg : $("#id").val()
		}, function(result) {
			if(confirm("确定要删除吗？")){
				if (result == 'true') {
					alert("删除成功!");
					$('#myform')[0].reset()
					window.location.href="../Resource/index2.html";
				}else if(result == 'existed'){
					alert("该资源存在子节点无法删除!");
					return;
				}
			}
		});
    }
    
    function focusKey(e) {
		if (key.hasClass("empty")) {
			key.removeClass("empty");
		}
	}
    
	function blurKey(e) {
		if (key.get(0).value === "") {
			key.addClass("empty");
		}
	}
	
	var lastValue = "", nodeList = [], fontCss = {};
	function clickRadio(e) {
		lastValue = "";
		searchNode(e);
	}
	
	function searchNode(e) {
		var zTree = $.fn.zTree.getZTreeObj("tree");
			var value = $.trim(key.get(0).value);
			var keyType = "resourcename";
			if (key.hasClass("empty")) {
				value = "";
			}
			if (lastValue === value) return;
			lastValue = value;
			if (value === "") return;
			updateNodes(false);
			nodeList = zTree.getNodesByParamFuzzy(keyType, value);
			updateNodes(true);

	}
	
	function updateNodes(highlight) {
		var zTree = $.fn.zTree.getZTreeObj("tree");
		zTree.expandAll(true); 
		for( var i=0, l=nodeList.length; i<l; i++) {
			nodeList[i].highlight = highlight;
			zTree.updateNode(nodeList[i]);
		}		
	}
	
	function getFontCss(treeId, treeNode) {
		return (!!treeNode.highlight) ? {color:"#FF6666", "font-weight":"bold"} : {color:"#333", "font-weight":"normal"};
	}
	
	function filter(node) {
		return !node.isParent && node.isFirstNode;
	}
	
	function expAllNodes(){
		var t = $.fn.zTree.getZTreeObj("tree");
		var nodes = t.getNodes();
		for(var i=0;i<nodes.length;i++){
			t.expandNode(nodes[i],true,true,true);
		}
		
	}
	
    var key;  
    $(document).ready(function() {  
        $.fn.zTree.init($("#tree"), setting);
        /* var t = $.fn.zTree.getZTreeObj("tree");       
        t.expandAll(true); */
        /* expAllNodes(); */
		key = $("#txtResName");
		key.bind("focus", focusKey);
		key.bind("blur", blurKey);
		key.bind("propertychange", searchNode);
		key.bind("input", searchNode);
    });
</script>